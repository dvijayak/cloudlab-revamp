 <!DOCTYPE html
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" id="viewport" content="height=device-height,width=device-width,user-scalable=no" />
		<title>Cloud Lab: Code Editor</title>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
		<script src="js/util.js"></script>		
		<script>
			var cookies = Util.cookiesToArray();			
			var data = "project=" + cookies['project'] + "&getFiles=true";
			Util.validateSession(function (output) {
				// Hide toolbar if Instructor
				var cookies = Util.cookiesToArray();
				if (cookies['role'] != "1") {	
					$( "#editor_toolbar" ).hide();
				}	
				
				// Generate list of files for the chosen project
				//Util.populateBrowser
				var files = output.data.files;
				var nFiles = files.length;
				for (var i = 0; i < nFiles; i++) {
					// Create the UI elements
					/* Note: by passing a data map to the click handler, we preserve the value of files[i].
					 * Otherwise, files[i] would take the value of undefined
					 */
					// Clicking on a files loads the files contents on to the editor
					$( "<li><a href='#'>" + files[i]['name'] + "." + files[i]['ext'] + "</a></li>").click({file: files[i]}, function (event) {
						//// Wrap the text in a <pre> tag to preserve code style and newline/carriage returns
						//var code = $( "<pre></pre>" ).html(event.data.file['contents']);
						//$( "#file_editor" ).html(code);
						editor.setValue(event.data.file['contents']);						
					}).appendTo( "#editor_listOfFiles" );
				}
			}, data);			
		</script>
		<style>
			
			html, body { padding: 0; margin: 0; width: 100%; height: 100%; }
			
			#editor_container {
				position: relative;				
				height: 250px;
			}
			
            #editor {
				display: block;
				overflow: auto;
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				padding: 0;
				margin: 0;                
                /*height: 500px*/
            }  			
		</style>
	</head>
	
	<body>						
		
		<div id="header">
			<script>
				$(function () {
					var cookies = Util.cookiesToArray();					
					$( "#header_title" ).text(cookies['course'].toUpperCase() + ": " + cookies['project'].toUpperCase());
				});
			</script>				
			<button id="back">Back</button <!-- TODO: Add a back arrow image -->			
			<span id="header_title"></span>
			<span id="header_username"></span>				
			<button id="logout">Logout</button>			
		</div>
				
		<!-- Only viewable by students -->
		<ul id="editor_toolbar">
			<script>
				$(function () {
					//$( "#editor_toolbar" ).menu();
				});
			</script>
			<li><a href="#">New</a></li>			
			<li><a id="compile" href="#">Compile</a></li>			
			<li><a id="run" href="#">Run</a></li>
			<li><a href="#">Compile & Run</a></li>
			<li><a href="#">Delete</a></li>
			<li><a href="#">Submit</a></li>
			<li><a href="#">Preferences</a></li>			
		</ul>		
		
		<fieldset>
			<legend>Edit File</legend>
			<!-- Dynamically populated via AWS RDS -->
			<div id="file_browser">
				<ul id="editor_listOfFiles">
					<!--<li><a href="">main.c</a></li>-->
					<!--<li><a href="">main.h</a></li>-->					
				</ul>
			</div>
		</fieldset>
		
		<fieldset id="editor_container">
			<legend>Code Editor</legend>
			<!-- Text from the file is displayed here -->
			<!-- TODO: Embed Ace Editor here -->			
			<div id="editor"></div>			
			<script type="text/javascript" src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js"></script>
			<script>
				// Initialize the ace editor object
				var editor = ace.edit("editor"),
					eSession = editor.getSession();
				editor.setTheme("ace/theme/monokai");
				eSession.setMode("ace/mode/c_cpp");
				editor.setValue("Welcome to your project! Select a file to edit.");
			</script>			
		</fieldset>
		
		<fieldset>
			<legend>Terminal</legend>
			<!-- A (currently) non-interactive terminal for displaying compiler and run-time output -->
			<!-- TODO: Embed Ace Editor here -->
			<div id="terminal">
				<!--<iframe width=100% height=100% src="http://23.21.85.72:8000"></iframe>-->
				<div id="cursors">
							<!-- The mouse pointers will be created here -->
						</div>
				
						<hgroup id="instructions">
							<h1>Draw anywhere!</h1>
							<h2>You will see everyone else who's doing the same.</h2>
							<h3>Tip: if the stage gets dirty, simply reload the page</h3>
						</hgroup>        
						
						<canvas id="paper" width="190" height="100">
							Your browser needs to support canvas for this to work!
						</canvas>
				
						<!-- socket.io.js is served by node.js -->
						<script src="http://localhost:8000/socket.io/socket.io.js"></script>						
						<script>
							$(function(){
							
								// This demo depends on the canvas element
								if(!('getContext' in document.createElement('canvas'))){
									alert('Sorry, it looks like your browser does not sup port canvas!');
									return false;
								}
															
								var url = Util.urls.node;
							
								var doc = $(document),
									win = $(window),
									canvas = $('#paper'),
									ctx = canvas[0].getContext('2d'),
									instructions = $('#instructions');
							
								// Generate an unique ID
								var id = Math.round($.now()*Math.random());
							
								// A flag for drawing activity
								var drawing = false;
							
								var clients = {};
								var cursors = {};
							
								var socket = io.connect(url);
							
								socket.on('moving', function (data) {
							
									if(! (data.id in clients)){
										// a new user has come online. create a cursor for them
										cursors[data.id] = $('<div class="cursor">').appendTo('#cursors');
									}
							
									// Move the mouse pointer
									cursors[data.id].css({
										'left' : data.x,
										'top' : data.y
									});
							
									// Is the user drawing?
									if(data.drawing && clients[data.id]){
							
										// Draw a line on the canvas. clients[data.id] holds
										// the previous position of this user's mouse pointer
							
										drawLine(clients[data.id].x, clients[data.id].y, data.x, data.y);
									}
							
									// Saving the current client state
									clients[data.id] = data;
									clients[data.id].updated = $.now();
								});
							
								var prev = {};
								
								$( "#compile" ).click(function() {									
									socket.emit('disconnect', function(){console.log("Disconnecting...");});
								});
							
								canvas.on('mousedown',function(e){
									e.preventDefault();
									drawing = true;
									prev.x = e.pageX;
									prev.y = e.pageY;
							
									// Hide the instructions
									instructions.fadeOut();
								});
							
								doc.bind('mouseup mouseleave',function(){
									drawing = false;
								});
							
								var lastEmit = $.now();
							
								doc.on('mousemove',function(e){
									if($.now() - lastEmit > 30){
										socket.emit('mousemove',{
											'x': e.pageX,
											'y': e.pageY,
											'drawing': drawing,
											'id': id
										});
										lastEmit = $.now();
									}
							
									// Draw a line for the current user's movement, as it is
									// not received in the socket.on('moving') event above
							
									if(drawing){
							
										drawLine(prev.x, prev.y, e.pageX, e.pageY);
							
										prev.x = e.pageX;
										prev.y = e.pageY;
									}
								});
							
								// Remove inactive clients after 10 seconds of inactivity
								setInterval(function(){
							
									for(ident in clients){
										if($.now() - clients[ident].updated > 10000){
							
											// Last update was more than 10 seconds ago.
											// This user has probably closed the page
							
											cursors[ident].remove();
											delete clients[ident];
											delete cursors[ident];
										}
									}
							
								},10000);
							
								function drawLine(fromx, fromy, tox, toy){
									ctx.moveTo(fromx, fromy);
									ctx.lineTo(tox, toy);
									ctx.stroke();
								}
							
							});            
						</script>				
			</div>
		</fieldset>
		<script src="http://localhost:8000/socket.io/socket.io.js"></script>
		
	</body>	
</html>

