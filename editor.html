<!DOCTYPE html>
<html>
    <head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" id="viewport" content="height=device-height,width=device-width,user-scalable=no" />
		<title>Cloud Lab: Editor</title>		
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
		<script src="js/util.js"></script>
		<script>			
			var clickedFile; // Document scope: Keep track of the file that was clicked
			var cookies = Util.cookiesToArray();
			// Ensure that the user properly lands on the page
			if (!cookies['course']) {
				window.location.href = "courses.html";
			}
			else if (!cookies['project']) {
				window.location.href = "projects.html";
			}
			var data = "project=" + cookies['project'] + "&getFiles=true";
			Util.validateSession(function (output) {
				if (output.status == "OK") {					
					// Generate list of files for the chosen project				
					var files = output.data.files;
					var nFiles = files.length;				
					for (var i = 0; i < nFiles; i++) {
						// Create the UI elements
						/* Note: by passing a data map to the click handler, we preserve the value of files[i].
						 * Otherwise, files[i] would take the value of undefined
						 */
						// Clicking on a file opens it
						$( "<li><a href='#'>" + files[i]['name'] + "." + files[i]['ext'] + "</a></li>").click({file: files[i]}, function (event) {
							openFile(event.data.file);
						}).appendTo( "#browser ul" );
						
						// Open the first file by default (can be changed to open last saved file via cookies, etc.)
						if (i == 0) {
							openFile(files[i]);
						}
					}
				}
				else if (output.status == "ZERO_RESULTS") {
					$( "#browser" ).text("There are no files for this project.");			
				}
				// Show toolbar if Student
				var cookies = Util.cookiesToArray();
				if (cookies['role'] == "1") {	
					$( "#toolbar" ).slideDown('fast');					
					$( "body" ).css('padding-top', '180px');
					$( "#statusbar" ).css('margin-top', '120px');
				}					
			}, data);
			
			// Open the specified file and load its contents in the editor
			var openFile = function (file) {
				var name = file['name'] + "." + file['ext'];
				changeStatus(StatusBarLevel.NORMAL, "Opening " +  name + "...");				
				
				var data = "name=" + file['name'] + "&ext=" + file['ext'] + "&openFile=true";
				$.post(Util.ajax.url, data, function (output) {
					if (output.status == "OK") {
						// Remember the currently opened file
						clickedFile = {
							"name" : file['name'],
							"ext" : file['ext']
						};
						EM.editor.setValue(output.data.contents, 1);																		
						changeStatus(StatusBarLevel.SUCCESS, name + " was opened successfully.");
					}
					else {						
						changeStatus(StatusBarLevel.ERROR, "Attempt to open " + name + " failed!");
					}
				}, Util.ajax.dataType);										
			}
			
			// A mapping between human-readable status levels and their respective classes
			var StatusBarLevel = {
				NORMAL : "alert",
				SUCCESS : "alert alert-success",
				INTERIM : "alert alert-info",
				WARNING : "alert alert-warning",
				ERROR : "alert alert-error"
			}
			
			// Changes the visual indication of the status as specified and displays the specified message in the status bar
			var changeStatus = function (status, message) {
				// Get all the classes that are currently attached to the element
				var oldClasses = $( "#statusbar #status" ).attr('class');
				// Remove the old classes and attach the new class
				$( "#statusbar #status" ).toggleClass(oldClasses + " " + status);
				// If a message is provided, display it
				if (message !== undefined) {
					$( "#statusbar #status" ).text(message);
					// Return the status bar back to normal after 3 seconds
					if (message != "Ready.") { // Avoids an endless recursive loop
						setTimeout(function () {
									changeStatus(StatusBarLevel.NORMAL, "Ready.")
								}, 5000);
					}
				}				
			}
			
		</script>		
        <!-- Bootstrap -->
        <link href="css/bootstrap.css" rel="stylesheet">
        <script src="js/bootstrap.min.js"></script>
		<script src="js/bootstrap-dropdown.js"></script>
		<script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/bootstrap-dropdown.js"></script>
		<!-- Also, all halfing images were provided by Glyphicons @ glyphicons.com -->
        <!--------------->
		<link href="css/general.css" rel="stylesheet">
        <style>
			body { padding-top: 120px;} /* Accounts for top fixed header */
			
			#toolbar {
				margin-top: 60px;
				display: none;
			}
			
			#statusbar {
				margin-top: 60px;
				text-align: center;
				line-height: 60px;
			}
			
			#browser li a {
				text-align: center;
			}
			
			/* Get a child container to fill up a parent container
			 * (Got this to work after hours of pulling hair out of my head)
			 * ========================================================== */
			#editorContainer, #terminalContainer {				
				position: relative;				
			}
			
			#editorContainer {
				height: 100%;
			}
			
			#terminalContainer {
				height: 100%;
			}
			
            #editor, #terminal {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;				
				font-size: 16px;
            }
			
			/* ========================================================== */

			#terminal {
				/*background-color: black;*/
				/*color: white;*/
			}
			
			.container-fluid {
				/*padding: 0;*/
			}
			
			.editor {
				height:850px;
			}

        </style>		
    </head>
    <body>
 		<div id="header" class="navbar navbar-fixed-top navbar-inverse">
			<script>
				$(function () {
					var cookies = Util.cookiesToArray();					
					$( "#header #title" ).text(cookies['course'].toUpperCase() + ": " + cookies['project'].toUpperCase());
				});
			</script>				
			<div class="navbar-inner">
				<div class="pull-left">
					<a id="back" class="btn btn-primary" href="#"><i class="icon-arrow-left icon-white"></i> Back</a>
				</div>
				<ul class="nav">					
					<li>
						<p id="title" class="navbar-text"></p>
					</li>					
				</ul>
				<div class="pull-right">
					<ul class="nav">
						<li>
							<p id="user" class="navbar-text"></p>
						</li>
					</ul>
					<a id="logout" class="btn btn-danger" href="#">Logout</a>					
				</div>
			</div>
		</div>
		
		<!-- Status Bar -->
		<div id="statusbar" class="navbar navbar navbar-fixed-top">
			<div class="navbar-inner">				
				<span id="status" class="alert">Ready.</span>
				<div class="pull-right">
					<button id="clear" class="btn btn-inverse"><b>Clear Terminal</b></button>
					<script>
						$( "#clear" ).click(function () {			
							EM.terminal.setValue("", 1);
						});
					</script>
				</div>
			</div>
		</div>		
		
		<!-- Only viewable by students -->
		<div id="toolbar" class="navbar navbar-fixed-top">
			<script>
				// Save the contents of the current file in the editor
				function saveFile () {
					var file = clickedFile['name'] + "." + clickedFile['ext'];
					changeStatus(StatusBarLevel.NORMAL, "Saving " +  file + "...");
					var contents = EM.editor.getValue();
					var data = "name=" + clickedFile['name'] + "&ext=" + clickedFile['ext'] +
						"&contents=" + contents + "&saveFile=true";
					$.post(Util.ajax.url, data, function (output) {						
						if (output.status == "OK") {
							changeStatus(StatusBarLevel.SUCCESS, file + " was saved successfully.");							
						}
						else {
							changeStatus(StatusBarLevel.ERROR, "Attempt to save " + file + " failed!");							
						}
					}, Util.ajax.dataType);
				}
				$(function () {
					$( "#save" ).click(saveFile);
				});
			</script>			
			<div class="navbar-inner">
				<ul class="nav">
					<li><a id="new" href="#">New</a></li>
					<li><a id="save" href="#">Save</a></li>
					<li><a id="rename" href="#">Rename</a></li>
					<li><a id="compile" href="#">Compile</a></li>
					<li><a id="run" href="#">Run</a></li>
					<li><a id="compilerun" href="#">Compile & Run</a></li>
					<li><a id="delete" href="#">Delete</a></li>
					<li><a id="submit" href="#">Submit</a></li>
					<li class="dropdown">
						<a id="preferences" href="#" class="dropdown-toggle" data-toggle="dropdown">
							Preferences
							<b class="caret"></b>
						</a>
						<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
							<li><a tabindex="-1" href="#">Theme</a></li>
							<li><a tabindex="-1" href="#">Theme</a></li>
							<li><a tabindex="-1" href="#">Theme</a></li>
							<li><a tabindex="-1" href="#">Theme</a></li>
							<li><a tabindex="-1" href="#">Theme</a></li>
							<li><a tabindex="-1" href="#">Theme</a></li>
							<li><a tabindex="-1" href="#">Theme</a></li>
							<li><a tabindex="-1" href="#">Theme</a></li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
		

		
		<div class="container-fluid">
			<div class="row-fluid editor">
				<!-- Browser (Dynamically populated via AWS RDS) -->
				<div id="browser" class="span2">
					<ul class="nav nav-list">
					</ul>	
				</div>
				<script type="text/javascript" src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js"></script>				
				<!-- Editor -->
				<div id="editorContainer" class="span6">
					<div id="editor"></div>
				</div>				
				<!-- Terminal -->
				<div id="terminalContainer" class="span4">
					<div id="terminal"></div>					
				</div>
				<script type="text/javascript" src="js/editormanager.js"></script>
			</div>			
		</div>								
				
		<script>
			$(function () {
											
				var url = Util.urls.node;							
		
				// Generate an unique ID (might be useful for v2.0)
				var id = Math.round($.now()*Math.random());
									
				var socket = io.connect(url);
				
				$( "#compile" ).click(function () {
					changeStatus(StatusBarLevel.NORMAL, "Compiling " +  clickedFile['name'] + "." + clickedFile['ext'] + "...");					
					var data = buildMessage(["contents"],
											[EM.editor.getValue()]);
					socket.emit('compile', data);
				});
				
				$( "#run" ).click(function () {
					changeStatus(StatusBarLevel.INTERIM, "Executing " +  clickedFile['name'] + "." + clickedFile['ext'] + "...");					
					var data = buildMessage();
					socket.emit('run', data);
				});
				
				$( "#compilerun" ).click(function () {
					changeStatus(StatusBarLevel.NORMAL, "Compiling and executing" +  clickedFile['name'] + "." + clickedFile['ext'] + "...");
					$( "#statusbar" ).text();
					var data = buildMessage(["contents"],
											[EM.editor.getValue()]);
					socket.emit('compilerun', data); 
				});
				
				// Helper function for creating the data for the message to be emitted
				function buildMessage (keys, values) {
					var cookies = Util.cookiesToArray();
					var data = {
						"user" : cookies['username'],
						"name" : clickedFile['name'],
						"ext" : clickedFile['ext']														
					};
					if (keys !== undefined && values !== undefined && keys.length == values.length) {
						var n = keys.length;							
						for (var i = 0; i < n; i++) {						
							data[keys[i]] = values[i];
						}
					};					
					return JSON.stringify(data); // Convert the data to valid JSON prior to emission
				}
				
				socket.on('output', function(data) {
					// If the response is valid JSON, it is runtime output
					try {
						changeStatus(StatusBarLevel.SUCCESS, "Finished executing " +  clickedFile['name'] + "." + clickedFile['ext'] + ".");
						var jsonData = JSON.parse(data);
						EM.appendValue("Runtime output:\n" +
							jsonData.stderr + "\n\nProgram output:\n" +
							jsonData.stdout + "\n===================\n", EM.terminal); // cursorPos: 0 or undefined is at the beginning; 1 is at the end
					}
					// else, it is compiler output
					catch (e) {
						changeStatus(StatusBarLevel.INTERIM, "Finished compiling " +  clickedFile['name'] + "." + clickedFile['ext'] + ".");
						EM.appendValue("Compiler output:\n" +
							data + "\n===================\n", EM.terminal); // cursorPos: same as above
					}
					
				});
			
			});            
		</script>

		
		<!-- socket.io.js for the clientside is served by the node.js server itself -->
		<script src="http://localhost:8000/socket.io/socket.io.js"></script> <!-- TODO: Change on server -->
		
    </body>
</html>