 <!DOCTYPE html
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" id="viewport" content="height=device-height,width=device-width,user-scalable=no" />
		<title>Cloud Lab: Code Editor</title>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
		<script src="js/util.js"></script>		
		<script>
			// Document scope: Keep track of the file that was clicked
			var clickedFile;
			var cookies = Util.cookiesToArray();			
			var data = "project=" + cookies['project'] + "&getFiles=true";
			Util.validateSession(function (output) {
				// Hide toolbar if Instructor
				var cookies = Util.cookiesToArray();
				if (cookies['role'] != "1") {	
					$( "#editor_toolbar" ).hide();
				}	
				
				// Generate list of files for the chosen project
				//Util.populateBrowser
				var files = output.data.files;
				var nFiles = files.length;
				for (var i = 0; i < nFiles; i++) {
					// Create the UI elements
					/* Note: by passing a data map to the click handler, we preserve the value of files[i].
					 * Otherwise, files[i] would take the value of undefined
					 */
					// Clicking on a files loads the files contents on to the editor
					$( "<li><a href='#'>" + files[i]['name'] + "." + files[i]['ext'] + "</a></li>").click({file: files[i]}, function (event) {
						// Update the text of the editor element
						EM.editor.setValue(event.data.file['contents'], 1);
						// Keep track of the file that was clicked
						clickedFile = {
							"name" : event.data.file['name'],
							"ext" : event.data.file['ext']
						}
						//console.log(clickedFile);
					}).appendTo( "#editor_listOfFiles" );
				}
			}, data);			
		</script>
		<style>
			
			html, body { padding: 0; margin: 0; width: 100%; height: 100%; }
			
			/* Get a child container to fill up a parent container
			 * (Got this to work after hours of pulling hair out of my head)
			 * ========================================================== */
			#editor_container, #terminal_container {
				margin: 0;
				padding: 0;
				position: relative;				
				height: 250px;							
			}
			
            #editor, #terminal {				
				margin: 0;
				padding: 0;
				display: block;
				overflow: auto;
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;				    
                /*height: 500px*/
				
				font-size: 16px;
            }
			
			/* ========================================================== */

			#terminal {
				background-color: black;
				color: white;
			}
		</style>
	</head>
	
	<body>						
		
		<div id="header">
			<script>
				$(function () {
					var cookies = Util.cookiesToArray();					
					$( "#header_title" ).text(cookies['course'].toUpperCase() + ": " + cookies['project'].toUpperCase());
				});
			</script>				
			<button id="back">Back</button <!-- TODO: Add a back arrow image -->			
			<span id="header_title"></span>
			<span id="header_username"></span>				
			<button id="logout">Logout</button>			
		</div>
				
		<!-- Only viewable by students -->
		<ul id="editor_toolbar">
			<script>
				$(function () {
					//$( "#editor_toolbar" ).menu();
				});
			</script>
			<li><a id="new" href="#">New</a></li>
			<li><a id="save" href="#">Save</a></li>
			<li><a id="compile" href="#">Compile</a></li>			
			<li><a id="run" href="#">Run</a></li>
			<li><a id="compilerun" href="#">Compile & Run</a></li>
			<li><a id="delete" href="#">Delete</a></li>
			<li><a id="submit" href="#">Submit</a></li>
			<li><a id="preferences" href="#">Preferences</a></li>			
		</ul>		
		
		<fieldset>
			<legend>Edit File</legend>
			<!-- Dynamically populated via AWS RDS -->
			<div id="file_browser">
				<ul id="editor_listOfFiles">
					<!--<li><a href="">main.c</a></li>-->
					<!--<li><a href="">main.h</a></li>-->					
				</ul>
			</div>
		</fieldset>
		
		<div id="editor_container">
			<legend>Code Editor</legend>
			<!-- Text from the file is displayed here -->					
			<div id="editor"></div>						
		</div>
		<script type="text/javascript" src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js"></script>
		
		<div id="terminal_container">
			<!-- A (currently) non-interactive terminal for displaying compiler and run-time output -->
			<div id="terminal">	
			</div>					

			<script type="text/javascript" src="js/editormanager.js"></script>	
		</div>
		<script>
			$(function () {
											
				var url = Util.urls.node;							
		
				// Generate an unique ID (might be useful for v2.0)
				var id = Math.round($.now()*Math.random());
									
				var socket = io.connect(url);
				
				$( "#compile" ).click(function () {					
					var data = buildMessage(["contents"],
											[EM.editor.getValue()]);
					socket.emit('compile', data);
				});
				
				$( "#run" ).click(function () {					
					var data = buildMessage();
					socket.emit('run', data);
				});
				
				$( "#compilerun" ).click(function () {
					var data = buildMessage(["contents"],
											[EM.editor.getValue()]);
					socket.emit('compilerun', data); 
				});
				
				// Helper function for creating the data for the message to be emitted
				function buildMessage (keys, values) {
					var cookies = Util.cookiesToArray();
					var data = {
						"user" : cookies['username'],
						"name" : clickedFile['name'],
						"ext" : clickedFile['ext']														
					};
					if (keys !== undefined && values !== undefined && keys.length == values.length) {
						var n = keys.length;							
						for (var i = 0; i < n; i++) {						
							data[keys[i]] = values[i];
						}
					};					
					return JSON.stringify(data); // Convert the data to valid JSON prior to emission
				}
				
				socket.on('output', function(data) {
					// If the response is valid JSON, it is runtime output
					try {
						var jsonData = JSON.parse(data);
						EM.appendValue("Runtime output:\n" +
							jsonData.stderr + "\n\nProgram output:\n" +
							jsonData.stdout + "\n===================\n", EM.terminal); // cursorPos: 0 or undefined is at the beginning; 1 is at the end
					}
					// else, it is compiler output
					catch (e) {
						EM.appendValue("Compiler output:\n" +
							data + "\n===================\n", EM.terminal); // cursorPos: same as above
					}
					
				});
			
			});            
		</script>
		<button id="clear">Clear</button>
		<script>
			$( "#clear" ).click(function () {			
				EM.terminal.setValue("", 1);
			});
		</script>
		
		<!-- socket.io.js for the clientside is served by the node.js server itself -->
		<script src="http://23.21.85.72:8000/socket.io/socket.io.js"></script>
		
	</body>	
</html>

